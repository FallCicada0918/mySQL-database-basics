
# 1 数据库事务
## 1.1概述
> 事务（Transaction），是由一系列对数据库表中数据，进行访问与更新的操作，所组成的一个执行逻辑单元
* 只有DML语句才会产生事务，其他语句不会产生事务

* DML语句执行的时候，如果当前有事务，那么就使用这个事务。如果当前没有事务，则产生一个新事务

* commit、rollback、DDL语句都可以把当前事务给结束掉

* commit和DDL语句结束事务的方式是把这个事务给提交了，然后DML操作永久生效

* rollback结束事务的方式是把这个事务给回滚了，默认回滚到事务开始的状态

* mysql默认是开启事务，即 autocommit = 1，自动提交事务。即执行insert、update、delete操作，立刻提交。

##### 事务生命周期
![](https://gitee.com/fallcicada/picture-bed/raw/master/photo/MySQL/%E8%AF%BE%E7%94%A8_4_%E4%BA%8B%E5%8A%A1%E7%B4%A2%E5%BC%95%E8%A7%86%E5%9B%BE/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-10-30%20145636.png)

MySQL事务的生命周期包括以下几个阶段：

1. 开始（BEGIN）：事务的生命周期始于BEGIN语句的执行。在开始阶段，MySQL会为该事务分配一个唯一的事务ID，并开始记录事务日志。

2. 执行（执行SQL语句）：在事务开始后，可以执行多个SQL语句，包括插入（INSERT）、更新（UPDATE）、删除（DELETE）等操作。这些操作会在事务日志中进行记录，但并不会立即影响数据库的实际数据。

3. 提交（COMMIT）：当所有SQL语句执行完毕后，可以选择提交事务。提交操作会将事务中的所有修改永久保存到数据库中，并释放相关的锁资源。

4. 回滚（ROLLBACK）：在事务执行过程中，如果发生错误或需要取消之前的修改，可以选择回滚事务。回滚操作会撤销事务中的所有修改，恢复到事务开始前的状态。

5. 结束（END）：事务的生命周期在提交或回滚后结束。结束阶段会释放所有与该事务相关的资源，并关闭事务日志。

需要注意的是，MySQL默认使用自动提交模式（autocommit），即每个SQL语句都被视为一个单独的事务，会自动执行提交操作。如果需要使用显式事务控制，可以使用BEGIN、COMMIT和ROLLBACK语句来手动管理事务的生命周期

## 1.2 事务特征
数据库事务必须具备ACID特性：**Atomic（原子性）、Consistency（一致性）、Isolation（隔离性）和Durability（持久性）**的英文缩写。

* 原子性（Atomicity）
    
    一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。
    如：张三转账给李四钱，转账过程中停电了，应该转账不生效（回退），事务的原子性
* 一致性（Consistency）

    事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。
    
    张三转账给李四钱，转帐之前和转账之后，账务总额应该保持不变。
* 隔离性（Isolation）

    指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。事务查看数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。

    如：张三转账过程，李四看不到张三账户的变化
    
* 持久性（Durability）

    指的是只要事务成功结束，它对数据库所做的更新就必须永久保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。

    如：如果转到错误的人的账户上，钱是退不回来的，事务一旦完成，事务中所涉及的数据，不能再被此次事务所更改。

## 1.3 提交回滚

### 查看事务
mysql默认是开启事务，即 autocommit = 1，自动提交事务。即执行`insert` 、`update` 、`delete` 操作，立刻提交。
```SQL
select @@autocommit;
```
![](https://gitee.com/fallcicada/picture-bed/raw/master/photo/MySQL/%E8%AF%BE%E7%94%A8_4_%E4%BA%8B%E5%8A%A1%E7%B4%A2%E5%BC%95%E8%A7%86%E5%9B%BE/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-10-30%20150814.png)

### 开启事务 
在MySQL命令行的默认设置下，事务都是自动提交的，即执行SQL语句后就会马上执行COMMIT操作。

因此要显式的开启一个事务须使用命令`BEGIN`或`START TRANSACTION`，或者执行命令`SET AUTOCOMMIT=0`，用来禁止使用当前会话的自动提交。

语法：

```SQL
-- 开启1个事务
begin;

-- 也可以使用 
start transaction;

-- 也可以使用，关闭事务自动提交，改为手动提交 
SET AUTOCOMMIT=0;
```
### 事务提交 

开启事务以后，执行DML语句遇到commit关键字或DDL语句，会提交事务。

例如：

```SQL
-- 开启事务手动提交
SET AUTOCOMMIT=0;

insert ... 第一次执行DML语句，新建事务(用A标识)
update ... 这个操作是事务A中的操作
insert ..  这个操作是事务A中的操作

commit;    让事务A里面的三个操作生效、事务A结束

delete ... 此时没有事务，执行新的DML语句会产生新事务(用B标识)
insert ..  这个操作是事务B中的操作
insert ..  这个操作是事务B中的操作
rename ..  遇到DDL语句，事务自动提交

insert ..  此时没有事务，执行新DML会创建新事务(用C标识)
```

注意：有一些语句会使得事务结束
* DDL语句，ALTER DATABASE、ALTER EVENT、ALTER PROCEDURE、ALTERTABLE、ALTER VIEW、CREATE TABLE、DROP TABLE、RENAME TABLE、TRUNCATE TABLE等；

* 修改MYSQL架构的语句，CREATE USER、DROP USER、GRANT、RENAMEUSER、REVOKE、SET PASSWORD；
  
* 管理语句，ANALYZE TABLE、CACHE INDEX、CHECK TABLE、LOAD INDEX INTO CACHE、OPTIMIZE TABLE、REPAIR TABLE等。

测试用表:

```SQL
-- 新建测试表
create table t_customer(
    id int,
    name varchar(20) not null,
    primary key(id)
    );
    
-- 测试完成可以删除表
drop table t_customer;
```

例如:
```SQL
-- 开启事务
begin;

insert into t_customer(id,name) values(1,'tom');
insert into t_customer(id,name) values(2,'jack');
insert into t_customer(id,name) values(3,'rose');
update t_customer set name='lucy' where id=1;
commit;

-- 开启事务
begin;
delete from t_customer where id=3;
update t_customer set name='lily' where id=2;
select * from t_customer;

-- DDL语句，会自动提交事务
alter table user3 add phone varchar(20);    
select * from t_customer;
```

>注意，测试时需要使用同一个mysql账号，在俩个终端窗口中进行登录，然后观察事务的提交与否，对用户查看数据的影响

### 事务回滚

>在进行事务回滚的时候，默认是回滚到事务开始时候的状态

同时，在事务中，我们也可以设置多个回滚点，让事务回滚到指定的位置。例如，使用关键字`savepoint` ，用来设置回滚点

```SQL
DML语句1
savepoint A
DML语句2
savepoint B
DML语句3
rollback to A/B
rollback
```
<font color = red>注意事项：rollback to 回滚点，此时事务并没结束。这个时候还可以接着rollback回滚或者commit提交，使事务结束。</font>

案例:

```SQL
create table t_user(
    id int primary key,
    name varchar(100),
    salary int
);

-- 开启事务
start transaction;

insert into t_user values(1,'tom',1000);
savepoint A;
insert into t_user(id,name) values(2,'zs');
savepoint B;
delete from t_user;

-- 回滚到B
rollback to B;
select * from t_user;

-- 回滚事务（生效）
rollback
select * from t_user;
 
 -- 测试完成后可以删除表
drop table t_user;
```
查询结果:

```SQL
select * from t_user;
```

